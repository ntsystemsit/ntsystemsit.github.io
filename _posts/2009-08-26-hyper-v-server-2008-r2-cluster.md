---
layout: post
title: "Hyper-V Server 2008 R2 Cluster"
date: 2009-08-26 23:00:00 +0200
comments: true
published: true
excerpt_separator: <!-- more -->
tags: ["Client", "Hyper-V", "Server", "Server 2008 R2"]
redirect_from: ["/post/Hyper-V-Server-2008-R2-Cluster", "/post/hyper-v-server-2008-r2-cluster"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>Da der Hyper-V Server 2008 R2 und der Windows Server 2008 R2 nun RTM sind, habe ich mir den Hyper-V Cluster näher angeschaut.    <br />    <br />Für die Simulation habe ich 3 physische Computer verwendet:</p>  <p>2 Hyper-V Server 2008 R2   <br />1 Windows Server 2008 R2 (inkl. iSCSI Target)</p>  <p>Das zentrale Storage wird über iSCSI angebunden. Dafür verwenden wir den Windows Server 2008 R2.</p>  <p><strong>Topologie</strong></p>  <p>&#160;<a href="/assets/image_59.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_59.png" width="244" height="128" /></a> </p>  <p>Um den Cluster zu erstellen müssen 8 Schritte durchgeführt werden:</p>  <p><strong>Schritt 1 Hyper-V Server und Server 2008 R2 auf den 3 Computern installieren</strong></p>  <p>Die beiden Hyper-V Server werden mit der Standard-Installation installiert. Der Windows Server 2008 R2 wird zusätzlich zum DC heraufgestuft um die Domäne <strong>hyper.local </strong>bereit zu stellen.</p>  <p><strong>Schritt 2 Firewall deaktivieren</strong></p>  <p>Für den Test habe ich auf den 3 Servern die Firewall deaktiviert, um nicht die entsprechenden Ports öffnen zu müssen.</p>  <p><strong>Schritt 3 Hyper-V Server in Domäne aufnehmen</strong></p>  <p>Als nächstes werden die Hyper-V Server in die Domäne aufgenommen.</p>  <p><strong>Schritt 4 Verwaltungstools auf dem Windows Server installieren</strong></p>  <p>Um den Cluster später steuern zu können müssen wir 2 Konsolen installieren: Clusterverwaltung und die Hyper-V Tools. Die Konsolen können unter den Features aktiviert werden.</p>  <p><a href="/assets/Screenshot1.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot1" border="0" alt="Screenshot1" src="/assets/Screenshot1_thumb.png" width="244" height="181" /></a> </p>  <p><strong>Schritt 5 iSCSI Target installieren und konfigurieren</strong></p>  <p>Als iSCSI Target Software habe ich das Tool von <a href="http://www.starwindsoftware.com/Free-Trial?_kk=iscsi%20target&amp;_kt=637ad5a7-0cc9-4eb7-995a-32c7ec208e7a&amp;gclid=CKLk_NSEwpwCFQcTzAod3S7xtw" target="_blank">StarWind</a> verwendet. Nachdem das Programm installiert wurde, kann man sich unter den Benutzernamen “test”, Password “test” anmelden und das Target entsprechen konfigurieren.</p>  <p><a href="/assets/Screenshot3.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot3" border="0" alt="Screenshot3" src="/assets/Screenshot3_thumb.png" width="244" height="98" /></a></p>  <p>Am iSCSI Target erstellen wir zunächst 2 virtuelle Volumes. 1 Volume wird als Quorumdatenträger für den Cluster verwendet, das andere als Storage für die VHD’s. Wichtig ist dabei, dass die Option <strong>“Allow multiple concurrent iSCSI connections (clustering)”</strong> verwendet wird, somit können beide Hyper-V Knoten gleichzeitig auf die Volumes zugreifen.</p>  <p><a href="/assets/Screenshot5.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot5" border="0" alt="Screenshot5" src="/assets/Screenshot5_thumb.png" width="244" height="189" /></a></p>  <p><strong>Schritt 6 Hyper-V Server mit den iSCSI Volumes verbinden</strong></p>  <p>Jetzt muss noch die Verbindung zwischen den Hyper-V Server und dem iSCSI Target hergestellt werden. In der Version R2 des Hyper-V Servers wurde eine grafische Oberfläche für den iSCSI-Initiator hinzugefügt. Der Initiator wird mit den Command <strong>iscsicpl</strong> gestartet. Nachdem wir zugestimmt haben den iSCSI Dienst zu starten, erhalten wir die Oberfläche wo wir die IP Adresse des iSCSI Targets eintragen und uns zunächst nur mit dem Quorum Volume verbinden.</p>  <p><a href="/assets/Screenshot7.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot7" border="0" alt="Screenshot7" src="/assets/Screenshot7_thumb.png" width="175" height="244" /></a></p>  <p>Jetzt muss das Volume noch entsprechend Formatiert werden.</p>  <p><strong>Schritt 7 Cluster einrichten</strong></p>  <p>Nun können wir den Cluster erstellen. Wir verbinden uns auf die Hyper-V Server und aktivieren mit <strong>Option 11</strong> die Failoverclusterfeatures.</p>  <p><a href="/assets/Screenshot9.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot9" border="0" alt="Screenshot9" src="/assets/Screenshot9_thumb.png" width="244" height="123" /></a></p>  <p>Nachdem die Features auf beiden Servern aktiviert sind, öffnen wir den Failovercluster-Manager auf dem Windows Server und starten die Clusterkonfiguration.</p>  <p><a href="/assets/Screenshot10.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot10" border="0" alt="Screenshot10" src="/assets/Screenshot10_thumb.png" width="244" height="200" /></a></p>  <p>Nachdem wir beide Hyper-V Server für den Cluster angegeben haben, startet die Konfigurationsüberprüfung. Sofern bis hierhin alle richtig Konfiguriert wurde, sollte der Check keine Fehler aufzeigen.</p>  <p><a href="/assets/Screenshot12.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot12" border="0" alt="Screenshot12" src="/assets/Screenshot12_thumb.png" width="244" height="171" /></a>&#160; </p>  <p>Nachdem der Cluster vollständig erstellt wurde, werden beide Hyper-V Server im Manager angezeigt.</p>  <p>Da wir den Quorumdatenträger bereits mit beiden Cluster-Knoten verbunden haben, wurde dieser erkannt und schon als Quorumdatenträger konfiguriert.</p>  <p><a href="/assets/Screenshot19.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot19" border="0" alt="Screenshot19" src="/assets/Screenshot19_thumb.png" width="244" height="109" /></a></p>  <p>Jetzt verbinden wir das Storage-Volume mit den beiden Cluster Knoten um auf die VHD’s zuzugreifen. Bevor das Volume benutzt werden kann, muss es noch formatiert werden.    <br />Jetzt aktivieren wir im Failovercluster-Manager die “<a href="http://technet.microsoft.com/en-us/library/dd630633(WS.10).aspx" target="_blank">Cluster Shared Volumes</a>” und erlauben somit gleichzeitigen Zugriff auf die VHD’s.</p>  <p><a href="/assets/image_60.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_60.png" width="233" height="244" /></a> </p>  <p>Um nun das Storage-Volume einzubinden, müssen wir es zunächst dem “Speicher” und dann den “Freigegeben Clustervolumes” (Cluster Shared&#160; Volumes) hinzufügen.</p>  <p><a href="/assets/Screenshot24.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot24" border="0" alt="Screenshot24" src="/assets/Screenshot24_thumb.png" width="244" height="179" /></a></p>  <p>Sobald Cluster Shared Volumes verwendet werden, kann man auf diese unter C:\ClusterStorage\ zugreifen. Für jedes Volume wird ein eigener “Ordner” erstellt.</p>  <p><a href="/assets/Screenshot20.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot20" border="0" alt="Screenshot20" src="/assets/Screenshot20_thumb.png" width="244" height="123" /></a></p>  <p><strong>Schritt 7 Virtuelle Maschine erstellen</strong></p>  <p>Als nächstes erstellen wir eine virtuelle Maschine (z.B. Windows XP) und ein virtuelles Netzwerk über die zuvor installierte Hyper-V Konsole auf einem der Hyper-V Server. Die VHD und entsprechende Konfigurationsdatei wird dabei auf dem Storage-Volume erstellt.</p>  <p><a href="/assets/Screenshot25.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot25" border="0" alt="Screenshot25" src="/assets/Screenshot25_thumb.png" width="244" height="139" /></a> </p>  <p><strong>Wichtig: </strong>Die virtuelle Maschine muss mit dem Netzwerkadapter verbunden werden <strong>bevor</strong> sie hochverfügbar gemacht wird, sonst kann die Maschine nicht auf den anderen Knoten verschoben werden.</p>  <p><strong>Schritt 8 Virtuelle Maschine hochverfügbar machen</strong></p>  <p>Um die virtuelle Maschine hochverfügbar zu machen, fügen wir einen neuen Dienst hinzu. Dabei muss geachtet werden, dass sich die Maschine im Status beendet oder gespeichert befindet. Ich empfehle die Maschine komplett herunterzufahren um Probleme zu vermeiden. </p>  <p><a href="/assets/Screenshot26.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot26" border="0" alt="Screenshot26" src="/assets/Screenshot26_thumb.png" width="244" height="168" /></a></p>  <p>Wir erhalten danach eine Liste mit den virtuellen Maschinen. </p>  <p><a href="/assets/Screenshot27.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot27" border="0" alt="Screenshot27" src="/assets/Screenshot27_thumb.png" width="244" height="168" /></a></p>  <p>Nachdem wir die Testmaschine ausgewählt haben, startet die Konfiguration um den Host hochverfügbar zu machen.</p>  <p>Die Konfiguration ist soweit abgeschlossen.</p>  <p><strong>Test 1 Quick- und Live-Migration</strong></p>  <p>Quick- und Live-Migration sind beides Verfahren um virtuelle Maschine auf einen anderen Knoten zu verschieben.&#160; <br />Mehr Infos (Whitepapers) zu <a href="http://www.microsoft.com/downloads/info.aspx?na=90&amp;p=&amp;SrcDisplayLang=en&amp;SrcCategoryId=&amp;SrcFamilyId=fdd083c6-3fc7-470b-8569-7e6a19fb0fdf&amp;u=http%3a%2f%2fdownload.microsoft.com%2fdownload%2fC%2fC%2f7%2fCC7A50C9-7C10-4D70-A427-C572DA006E61%2fLiveMigrationWhitepaper.xps" target="_blank">Live-</a> und <a href="http://download.microsoft.com/download/8/2/f/82fa3808-7168-46f1-a07b-f1a7c9cb4e85/WS08%20Quick%20Migration%20with%20Hyper-V_Whitepaper_FINAL.doc" target="_blank">Quick-Migration</a></p>  <p><strong>Live Migration</strong>    <br />In meinen Test habe ich für die Live-Migration lediglich 1 Ping verloren.</p>  <p><a href="/assets/Screenshot28.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot28" border="0" alt="Screenshot28" src="/assets/Screenshot28_thumb.png" width="244" height="166" /></a>&#160;</p>  <p><a href="/assets/Screenshot29.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot29" border="0" alt="Screenshot29" src="/assets/Screenshot29_thumb.png" width="244" height="102" /></a></p>  <p><strong>Quick-Migration     <br /></strong>Für den Umzug auf den 2. Knoten durch Quick-Migration gingen 9 Pings an die virtuelle Maschine verloren.</p>  <p><a href="/assets/Screenshot30.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="Screenshot30" border="0" alt="Screenshot30" src="/assets/Screenshot30_thumb.png" width="244" height="112" /></a>&#160; </p>  <p><strong>Test 2 Ausfall von einem Hyper-V Server simulieren</strong></p>  <p>Als 2. Test habe ich den Stromstecker des Hyper-V Servers gezogen, der aktuell die virtuelle Maschine hostet. Der Failovercluster hat nach wenigen Sekunden die virtuelle Maschine auf dem 2. Konten neu gestartet.</p>  <p>   <br />Grüße,dn</p>
