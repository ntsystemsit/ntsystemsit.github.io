---
layout: post
title: "Upgrade Exchange 2k3 - 2010"
date: 2010-07-19 22:15:00 +0200
comments: true
published: true
excerpt_separator: <!-- more -->
categories: Archive
tags: ["Exchange"]
redirect_from: ["/post/Upgrade-Exchange-2k3-2010", "/post/upgrade-exchange-2k3-2010"]
author: daniel nitz
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>&#160;</p>  <p>In diesem Post werde ich das Upgrade von Exchange 2k3 zu 2010 beschreiben und einige bekannte Fehler und deren Lösung aufzeigen.</p>  <p>&#160;</p>  <p><strong>Upgrade</strong></p>  <p>&#160;</p>  <p>Um einen groben Überblick zu bekommen ob die Infrastruktur Exchange 2010 tauglich ist, empfehle ich den “<a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=88b304e7-9912-4cb0-8ead-7479dab1abf2&amp;displaylang=en" target="_blank">Microsoft Exchange Pre-Deployment Ananlyzer</a>” auszuführen. Dieses Tool führt einige Checks an der Struktur aus.</p>  <p>&#160;</p>  <ul>   <li><strong>Exchange Organisation in native mode setzen</strong></li> </ul>  <p>&#160;</p>  <p>Sofern das nicht schon passiert ist, muss die Organisation im nativen Modus geschalten werden.</p>  <p>&#160;</p>  <p><a href="/assets/image_168.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_166.png" width="219" height="244" /></a> </p>  <p>&#160;</p>  <ul>   <li><strong>Active Directory Schema upgrade</strong></li> </ul>  <p>&#160;</p>  <p>Jetzt muss das Schema geupdatet werden. Dazu startet man vom Schema Master folgende Setup Kommandos von der Exchange CD aus:</p>  <p>&#160;</p>  <p>Setup /PrepareLegacyExchangePermissions</p>  <p>Setup /PrepareSchema</p>  <p>Setup /PrepareAD [/OrganizationName:YOUR_DOMAIN]</p>  <p>Setup /PrepareDomain</p>  <p>&#160;</p>  <ul>   <li><strong>Link state suppression deaktivieren</strong></li> </ul>  <p>&#160;</p>  <p>In Exchange Server 2003 wurde für einen Server, der keine Connectoren besitzt ein anderer Pfad für den Versand gesucht. Diese Option wird ab Exchange 2007 nicht mehr unterstützt. Um die Koexistenz zu gewährleisten muss dieses Feature auf allen Exchange 2003 Server deaktiviert werden</p>  <p>&#160;</p>  <ol>   <li>Open Registry Editor.</li>    <li>Locate HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\RESvc\Parameters.</li>    <li>Right-click Parameters and select New | DWORD value. Name the new DWORD value SuppressStateChanges.</li>    <li>Double-click SuppressStateChanges.</li>    <li>In the Value data field, enter 1.</li>    <li>Close Registry Editor, and then restart the SMTP service, the Microsoft Exchange Routing Engine service, and the Microsoft Exchange MTA Stacks services for the change to take effect.</li> </ol>  <p>&#160;</p>  <ul>   <li><strong>Exchange 2010 System Requirements</strong></li> </ul>  <p>&#160;</p>  <p>Mit folgendem Kommando werden die nötigen Requirements auf dem Exchange Server installiert</p>  <p>&#160;</p>  <p>Add-WindowsFeature NET-Framework,RSAT-ADDS,Web-Server,Web-Basic-Auth,Web-Windows-Auth,Web-Metabase,Web-Net-Ext,Web-Lgcy-Mgmt-Console,WAS-Process-Model,RSAT-Web-Server,Web-ISAPI-Ext,Web-Digest-Auth,Web-Dyn-Compression,NET-HTTP-Activation,RPC-Over-HTTP-Proxy –Restart</p>  <p>&#160;</p>  <p>Zudem beim Dienst NetTCPPortSharing den Starttyp auf Automatisch setzen:</p>  <p>&#160;</p>  <p>Set-Service NetTcpPortSharing -StartupType Automatic</p>  <p>&#160;</p>  <p>&#160;</p>  <p><strong>Installation Client Access Rolle</strong></p>  <p>&#160;</p>  <p>Als erstes wird die Rolle “Client Access” installiert</p>  <p>&#160;</p>  <p><a href="/assets/image_169.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_167.png" width="244" height="213" /></a> </p>  <p>&#160;</p>  <p><a href="/assets/image_170.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_168.png" width="244" height="214" /></a> </p>  <p>&#160;</p>  <p>Wenn der Server z.B. über OWA erreicht werden soll muss noch die externe Adresse angegeben werden (Bsp: mail.contoso.com)</p>  <p>&#160;</p>  <p><a href="/assets/image_171.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_169.png" width="244" height="211" /></a> </p>  <p>&#160;</p>  <p><strong>Zertifikate installieren</strong></p>  <p>&#160;</p>  <p>Der nächste Schritt besteht darin die Zertifikate einzufügen und zu registrieren. Über den Exchange Zertifikatwizzard kann ein neues Exchange Zertifikat erstellt werden:</p>  <p>&#160;</p>  <p><a href="/assets/image_172.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_170.png" width="244" height="115" /></a> </p>  <p>&#160;</p>  <p>Jetzt müssen noch alle erforderlichen Optionen angegeben werden bevor die Anforderung erstellt werden kann:</p>  <p>&#160;</p>  <p><a href="/assets/image_173.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_171.png" width="244" height="208" /></a> </p>  <p>&#160;</p>  <p>Die Anforderung kann jetzt gespeichert werden. Diese muss dann über die Zertifizierungsstelle eingereicht werden und man erhält sein Zertifikat. Nachdem das Zertifikat ausgestellt wurde kann es über die Console der Anfrage hinzugefügt werden. Jetzt muss man dem Zertifikat noch die entsprechenden Dienste zuweisen:</p>  <p>&#160;</p>  <p><a href="/assets/image_174.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_172.png" width="244" height="214" /></a> </p>  <p>&#160;</p>  <p><strong>Installation Hub Transport Rolle</strong></p>  <p>&#160;</p>  <p>Jetzt wird die Rolle “Hub Transport” installiert.</p>  <p>&#160;</p>  <p><a href="/assets/image_175.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_173.png" width="244" height="213" /></a> </p>  <p>&#160;</p>  <p>Das Setup Programm weist darauf hin, dass es einen Connector benötigt um Mails von / zu den Exchange 2003 Servers zu senden. Es muss der Server ausgewählt werden, der zur gleichen Routinggruppe wie der Exchange Server 2010 zählt sofern mehrere 2003 Server in unterschiedlichen Standorten vorhanden sind.</p>  <p>&#160;</p>  <p>Wenn das Microsoft Filter Pack nicht installiert wurde wird man darauf hingewiesen es nach zu installieren:</p>  <p>&#160;</p>  <p><a href="/assets/image_176.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_174.png" width="244" height="74" /></a> </p>  <p>&#160;</p>  <p>Damit Active Sync in einer Exchange 2003 / 2010 Umgebung weiterhin funktioniert, muss die Authentifizierung für die Virtual Directory auf integrierte Windows Authentifizierung geändert werden.</p>  <p>Zuerst muss der Hotfix <a href="http://support.microsoft.com/?kbid=937031" target="_blank">KB937031</a> auf den Exchange 2003 Servern installiert werden um die entsprechende Einstellung setzen zu können.</p>  <p>Nachdem der Hotfix auf dem Exchange Server 2003 installiert wurde, lassen sich die Einstellungen für das ActiveSync virtuelle Verzeichnis ändern. Die Authentifizierung kann jetzt auf &quot;Integrierte Windows-Authentifizierung&quot; geändert werden</p>  <p>&#160;</p>  <p><a href="/assets/image_177.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_175.png" width="244" height="156" /></a> </p>  <p>&#160;</p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p><strong>Installation Mailbox Rolle</strong></p>  <p>&#160;</p>  <p>Jetzt wird die Mailbox Rolle installiert.</p>  <p>&#160;</p>  <p><a href="/assets/image_178.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_176.png" width="244" height="212" /></a> </p>  <p>&#160;</p>  <p>Jetzt verfügt man über ein vollwertige Exchange 2010 Installation. Für den Betrieb des Servers müssen noch einige Einstellungen vorgenommen werden.</p>  <p>&#160;</p>  <p><strong>Offline Adressbuch</strong></p>  <p>&#160;</p>  <p>Das offline Adressbuch muss auf den Exchange 2010 verschoben werden. Dies kann über die Console unter den Organisationseinstellungen gemacht werden. Zudem muss die Einstellung für den Webverteilung aktiviert werden. (Ab Outlook 2007 wird das Adressbuch über die Webservices geladen)</p>  <p>&#160;</p>  <p><a href="/assets/image_179.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_177.png" width="219" height="244" /></a> </p>  <p>&#160;</p>  <p><strong>Send Connector erstellen</strong></p>  <p>&#160;</p>  <p>Es wird ein neuer Send Connector erstellt, der für Exchange 2010 fungiert. Danach wird der alte Exchange 2003 Connector gelöscht.</p>  <p>&#160;</p>  <p><a href="/assets/image_180.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_178.png" width="244" height="213" /></a> </p>  <p>&#160;</p>  <p><strong>Receive Connector konfigurieren</strong></p>  <p>&#160;</p>  <p>Damit der Exchange Server Mails annimmt, muss ein neuer Connector erstellt werden, der für den anonymen Zugriff freigeschalten wird.</p>  <p>&#160;</p>  <p><a href="/assets/image_181.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_179.png" width="217" height="244" /></a> </p>  <p>&#160;</p>  <p><strong>Kompatibilität Outlook 2003</strong></p>  <p>&#160;</p>  <p>Outlook 2010, 2007 verwenden Standardmäßig die PRC Verschlüsselung, 2003 nicht. Bei Exchange Server 2010 werden per default nur verschlüsselte RPC Verbindungen angenommen. Dies kann jedoch mit folgendem Befehl über die Shell abgeschaltet werden:</p>  <p>&#160;</p>  <p>Set-RPCClientAccess – Server –YOURSERVER –EncryptionRequired $false</p>  <p>&#160;</p>  <p><a href="/assets/image_182.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_180.png" width="244" height="16" /></a></p>  <p>&#160;</p>  <p><strong> Öffentliche Ordner, Free / Busy Informationen synchronisieren</strong></p>  <p>&#160;</p>  <p>Um die Öffentlichen Ordner auf Exchange 2010 zu verschieben müssen diese repliziert werden. Diese Einstellungen werden auf dem Exchange 2003 vorgenommen. Hierzu wird der Exchange Server 2010 als Replikationspartner den Ordnern <strong>“Offline Address Book</strong>” und “<strong>Schedule + Free Busy</strong>” hinzugefügt.</p>  <p>&#160;</p>  <p><a href="/assets/image_183.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_181.png" width="244" height="199" /></a> </p>  <p>&#160;</p>  <p>Nachdem die Informationen repliziert wurden kann das Replikat von den Exchange 2003 Servern entfernt werden.</p>  <p>&#160;</p>  <p><strong>Adresslisten konvertieren</strong></p>  <p>&#160;</p>  <p>Um die Exchange 2003 Adresslisten in Exchange 2010 bearbeiten zu können müssen diese erst konvertiert werden (Exchange 2003 benutzte LDAP Filter). Dies wird über die Shell gemacht. </p>  <p>&#160;</p>  <p>Die Adresslisten können mit den folgenden Kommandos geupdatet werden:</p>  <p>&#160;</p>  <p>Bsp: Adressliste Verwaltung die auf die Abteilung gefiltert wird</p>  <p>&#160;</p>  <p>Set-AddressList &quot;Verwaltung&quot; -IncludedRecpients MailboxUsers</p>  <p>Set-AddressList &quot;Verwaltung&quot; -ConditionalDepartment Verwaltung</p>  <p>&#160;</p>  <p><strong>Addresspolicy updaten</strong></p>  <p>&#160;</p>  <p>Auch die Addresspolicy muss geupdatet werden, sonst erhält man folgende Meldung:</p>  <p>&#160;</p>  <p><a href="/assets/image_184.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_182.png" width="244" height="54" /></a> </p>  <p>&#160;</p>  <p>Das Update kann über folgenden Befehl gemacht werden:</p>  <p>&#160;</p>  <p>Set-EmailAddressPolicy “Default Policy” –IncludedRecipients AllRecipients</p>  <p>&#160;</p>  <p>&#160;</p>  <p><strong>Die Exchange Installation ist nun komplett und man kann beginnen die Mailboxen zu verschieben.     <br /></strong></p>  <p><strong>Wichtig: Nach der Installation sollte der Exchange BPA ausgeführt werden um sämtliche Einstellungen und Funktionen zu verifizieren.</strong></p>  <p>&#160;</p>  <p><strong></strong></p>  <p><strong></strong></p>  <p><strong>Fehler</strong></p>  <p>&#160;</p>  <p>Während dem Upgrade bin ich auf mehrere Fehler gestoßen die ich hier kurz samt Lösung erläutere:</p>  <p>&#160;</p>  <p><strong>Fehler 1</strong></p>  <p>&#160;</p>  <p>Log Name: Application</p>  <p>Source: MSExchange MailTips</p>  <p>Date: 12.07.2010 15:40:53</p>  <p>Event ID: 14003</p>  <p>Task Category: MailTips</p>  <p>Level: Error</p>  <p>Keywords: Classic</p>  <p>User: N/A</p>  <p>Computer: EX2k10.***</p>  <p>Description:</p>  <p>Unable to create Group Metrics distribution share.</p>  <p>Share: GroupMetrics</p>  <p>Directory: C:\Program Files\Microsoft\Exchange Server\V14\GroupMetrics</p>  <p>Message: 00000842</p>  <p>&#160;</p>  <p>Um diese Fehlermeldung zu beheben habe ich den Starttyp des Dienstes “<strong>Microsoft Echange Service Host</strong>” auf <strong>Automatic (Delayed Start)</strong> gesetzt</p>  <p>&#160;</p>  <p><strong>Fehler 2</strong></p>  <p>&#160;</p>  <p>Log Name: Application</p>  <p>Source: MSExchangeSA</p>  <p>Date: 12.07.2010 16:07:45</p>  <p>Event ID: 9323</p>  <p>Task Category: (13)</p>  <p>Level: Warning</p>  <p>Keywords: Classic</p>  <p>User: N/A</p>  <p>Computer: EX2k10.***</p>  <p>Description:</p>  <p>Entry 'Benutzer1' has invalid or expired e-mail certificates. These certificates will not be included in the offline address list for '\oGAL'. </p>  <p>- \Offline-EX2k10 </p>  <p>&#160;</p>  <p>Das bedeutet, dass Benutzer1 Fehlerhafte Zertifikate in AD besitzt. Diese müssen gelöscht werden (vorher in AD die erweiterten Eigenschaften einblenden).</p>  <p>&#160;</p>  <p><a href="/assets/image_185.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_183.png" width="244" height="202" /></a> </p>  <p>&#160;</p>  <p><strong>Fehler 3</strong></p>  <p>&#160;</p>  <p>Log Name: Application</p>  <p>Source: MSExchangeSA</p>  <p>Date: 12.07.2010 16:14:01</p>  <p>Event ID: 9359</p>  <p>Task Category: (13)</p>  <p>Level: Warning</p>  <p>Keywords: Classic</p>  <p>User: N/A</p>  <p>Computer: EX2k10.***</p>  <p>Description:</p>  <p>OALGen truncated or dropped properties for entry 'Discovery Search Mailbox' in address list '\oGAL’ because they exceeded the configured size limits for the version 4 offline address list. The affected MAPI ids are: 8cd8. </p>  <p>- \Offline-EX2k10 </p>  <p>&#160;</p>  <p>Dieser Fehler kann ignoriert werden, er ist ab Design so.</p>  <p>&#160;</p>  <p><strong>Fehler 4</strong></p>  <p>&#160;</p>  <p>Log Name: Application</p>  <p>Source: MSExchange ActiveSync</p>  <p>Date: 15.07.2010 09:50:07</p>  <p>Event ID: 1053</p>  <p>Task Category: Configuration</p>  <p>Level: Error</p>  <p>Keywords: Classic</p>  <p>User: N/A</p>  <p>Computer: EX2k10.***</p>  <p>Description:</p>  <p>Exchange ActiveSync doesn't have sufficient permissions to create the &quot;CN=Daniel Nitz,OU=***,OU=****,DC=***,DC=local&quot; container under Active Directory user &quot;Active Directory operation failed on **********. This error is not retriable. Additional information: Access is denied.</p>  <p>Active directory response: 00000005: SecErr: DSID-03151E04, problem 4003 (INSUFF_ACCESS_RIGHTS), data 0</p>  <p>&quot;.</p>  <p>Make sure the user has inherited permission granted to domain\Exchange Servers to allow List, Create child, Delete child of object type &quot;msExchangeActiveSyncDevices&quot; and doesn't have any deny permissions that block such operations.</p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p></p>  <p>&#160;</p>  <p>&#160;</p>  <p>Hier gibt es ein Rechte-Problem. Bei den User wurde wahrscheinlich in AD die Vererbung deaktiviert.</p>  <p>&#160;</p>  <p><strong>Fehler 5</strong></p>  <p>&#160;</p>  <p>Fehler beim Download des Offline Adressbuches:</p>  <p>&#160;</p>  <p><a href="/assets/image_186.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_184.png" width="244" height="156" /></a> </p>  <p>&#160;</p>  <p>Dieser Fehler kann behoben werden, indem im IIS des Exchange Servers im virtual Directory “OAB” die Einstellung gesetzt wird, dass nicht mehr SSL erzwunden werden muss.</p>  <p>&#160;</p>  <p><a href="/assets/image_187.png" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_185.png" width="244" height="238" /></a> </p>  <p>&#160;</p>  <p>Viel Spaß bei der Migration zu Exchange Server 2010!</p>  <p>&#160;</p>  <p>Grüße   <br />dn</p>
