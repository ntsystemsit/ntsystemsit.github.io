---
layout: post
title: "Sharepoint 2010, Fehler in der SQL Datenbank beheben"
date: 2010-08-23 20:37:00 +0200
comments: true
published: true
categories: ["blog", "archives"]
excerpt_separator: <!-- more -->
tags: ["Sharepoint"]
alias: ["/post/Sharepoint-2010-Fehler-in-der-SQL-Datenbank-beheben.aspx", "/post/sharepoint-2010-fehler-in-der-sql-datenbank-beheben.aspx"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>Letztens wollte ich einen Test-Restore meiner Sharepoint Datenbank durchführen. Normalerweise hat das immer problemlos funktioniert, jedoch beim letzten Backup gab es große Probleme mit dem Sharepoint-Inhalt. Der Restore-Vorgang wurde erfolgreich beendet, jedoch war lediglich die halbe Sharepoint Struktur und keine Daten enthalten.</p>  <p>Nachdem ich das Eventlog des Quellservers durchforstet habe, bin ich auf folgende Fehler im Anwendungs-Log gestoßen:</p>  <p><a href="/assets/image_220.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_218.png" width="244" height="168" /></a></p>  <p>Protokollname: Application   <br />Quelle:&#160;&#160;&#160;&#160;&#160;&#160;&#160; MSSQL$SHAREPOINT    <br />Datum:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 24.08.2010 15:46:37    <br />Ereignis-ID:&#160;&#160; 18053    <br />Aufgabenkategorie:Server    <br />Ebene:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Fehler    <br />Schlüsselwörter:Klassisch    <br />Benutzer:&#160;&#160;&#160;&#160;&#160; ******\daniel nitz    <br />Computer:&#160;&#160;&#160;&#160;&#160; Miami.*****.local    <br />Beschreibung:    <br />Fehler: 7884, Schweregrad: 20, Status: 1. (Parameter: ). Der Fehler wird aufgrund eines Formatierungsfehlers im nicht ausführlichen Modus gedruckt. Ablaufverfolgung, ETW, Benachrichtigungen usw. werden ausgelassen.    <br /></p>  <p><a href="/assets/image_221.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_219.png" width="244" height="167" /></a></p>  <p>Protokollname: Application   <br />Quelle:&#160;&#160;&#160;&#160;&#160;&#160;&#160; MSSQL$SHAREPOINT    <br />Datum:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 24.08.2010 15:46:37    <br />Ereignis-ID:&#160;&#160; 7105    <br />Aufgabenkategorie:Server    <br />Ebene:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Fehler    <br />Schlüsselwörter:Klassisch    <br />Benutzer:&#160;&#160;&#160;&#160;&#160; ******\daniel nitz    <br />Computer:&#160;&#160;&#160;&#160;&#160; Miami.*****.local    <br />Beschreibung:    <br />Die Datenbank-ID '6', Seite '(0:0)', Slot '0' für den LOB-Datentypknoten ist nicht vorhanden. Dies ist gewöhnlich auf Transaktionen zurückzuführen, die Daten, für die kein Commit ausgeführt wurde, auf einer Datenseite lesen können. Führen Sie DBCC CHECKTABLE aus.    <br /></p>  <p>Um den Fehler zu analysieren muss man zunächst das <a href="http://www.microsoft.com/downloads/details.aspx?familyid=08E52AC2-1D62-45F6-9A4A-4B76A8564A2B&amp;displaylang=de" target="_blank">SQL Server 2008 Management Studio Express</a> installieren. Über das Management Studio erhält man Zugriff auf dem SQL Server und kann mit dem Troubleshooting beginnen.    <br />Zunächst meldet man sich am SQL Server an. Als Servername verwenden wir <strong>SERVER\Sharepoint</strong></p>  <p><a href="/assets/image_222.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_220.png" width="244" height="181" /></a></p>  <p>Nun ist die Verbindung zum Server hergestellt. Jetzt muss die Datenbank mit der ID ‘6’ (wie in der Fehlermeldung 2) gefunden werden. Als erstes öffnen wir ein Abfragefenster und gehen jede Datenbank mit </p>  <p><strong>use NAME-DER-DATENBANK     <br />select db_id()</strong></p>  <p><a href="/assets/image_223.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_221.png" width="244" height="168" /></a></p>  <p>durch, bis uns die entsprechende ID im Fenster “Meldungen” ausgegeben wird. In meinen Fall war das die Datenbank <strong>WSS_CONTENT</strong>.</p>  <p>Nun führen wir den Befehl <strong>DBCC CHECKDB (WSS_CONTENT) WITH NO_INFOMSGS, ALL_ERRORMSGS</strong> aus und bekommen eine Liste mit den entsprechenden Fehlern</p>  <p><a href="/assets/image_224.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_222.png" width="244" height="111" /></a></p>  <p><strong>In meinem Fall:</strong></p>  <p><font color="#ff0000">Meldung 8965, Ebene 16, Status 1, Zeile 1     <br /></font><font color="#ff0000">Tabellenfehler: Objekt-ID 69575286, Index-ID 1, Partitions-ID 72057594113359872, Zuordnungseinheits-ID 72057594043760640 (LOB data-Typ). Auf den Datenknoten außerhalb von Zeilen auf Seite (0:0), Slot 0, Text-ID 1759772672 wird von Seite (1:4986), Slot 6 verwiesen, er wurde jedoch im Scan nicht betrachtet.     <br /></font><font color="#ff0000">Meldung 8929, Ebene 16, Status 1, Zeile 1     <br /></font><font color="#ff0000">Objekt-ID 69575286, Index-ID 1, Partitions-ID 72057594113359872, Zuordnungseinheits-ID 72057594123255808 (In-row data-Typ): Es wurden Fehler in Daten außerhalb von Zeilen gefunden mit der ID 1759772672, im Besitz von data, Datensatz identifiziert durch RID = (1:4986:6).     <br /></font>Von CHECKDB wurden 0 Zuordnungsfehler und 2 Konsistenzfehler in der 'AllDocs'-Tabelle (Objekt-ID 69575286) gefunden.    <br />Von CHECKDB wurden 0 Zuordnungsfehler und 2 Konsistenzfehler in der 'WSS_Content'-Datenbank gefunden.    <br />repair_allow_data_loss ist die minimale Reparaturstufe für die Fehler, die mit DBCC CHECKDB (WSS_Content) gefunden wurden.</p>  <p>&#160;</p>  <p>Die Meldungen weisen darauf hin, dass eine Inkonsistenz in der Datenbank vorliegt. Höchstwahrscheinlich handelt es sich dabei um eine Datei, die auf dem Sharepoint Server upgeloaded wurde. Um die Inkonsistenz zu beheben muss <strong>DBCC CHECKDB </strong>mit dem Parameter <strong>repair_allow_data_loss </strong>ausgeführt werden. </p>  <p>Dafür müssen zunächst alle Sharepoint Dienste und der IIS Dienst beendet werden.   <br />Danach müssen die folgenden Kommandos ausgeführt werden:</p>  <p><a href="/assets/image_225.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_223.png" width="244" height="109" /></a></p>  <p>Mit dem Befehl <strong>ALTER DATABASE WSS_Content SET SINGLE_USER</strong>, wird die Datenbank in den Sinlge_Mode gesetzt, der Befehl <strong>DBCC CHECKDB (WSS_Content, REPAIR_ALLOW_DATA_LOSS)</strong> startet die Reparatur.</p>  <p>Nachdem die Reparatur abgeschlossen wurde und DBCC CHECKDB keine Fehler mehr protokolliert, kann der Modus wieder zu MULTI_USER geändert werden.</p>  <p><a href="/assets/image_226.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_224.png" width="244" height="129" /></a></p>  <p>Jetzt können alle Dienste wieder gestartet werden. Die Datenbank sollte jetzt konsistent sein und die Sicherung vollständig durchlaufen.</p>  <p>Grüße   <br />dn</p>
