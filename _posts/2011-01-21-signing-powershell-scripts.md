---
layout: post
title: "Signing PowerShell Scripts"
date: 2011-01-21 23:19:35 +0100
comments: true
published: true
categories: ["blog", "archives"]
excerpt_separator: <!-- more -->
tags: ["PowerShell"]
alias: ["/post/Signing-PowerShell-Scripts.aspx", "/post/signing-powershell-scripts.aspx"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>Damit ein PowerShell Script signiert werden kann muss man im besitz eines Zertifikates mit dem “Intended Purpose” Code Signing sein. So ein Zertifikat kann man sich selbst ausstellen, oder von einer Enterprise CA anfordern. Natürlich kann man es auch kaufen…</p>  <p>Wie man ein SelfSigned Zertifikat erstellt ist ausführlich in der Hilfe beschrieben, einfach “Get-Help about_signing” ausführen.</p>  <p>Um ein Code Signing Zertifikat von Enterprise Zertifizierungsstelle anzufordern muss man “Enroll” Berechtigungen auf die Zertifikatsvorlage haben, oder man kopiert die Vorlage und erstellt eine eigene, z.B. mit längerer Gültigkeit.</p>  <p>Hat man also ein Zertifikat erhalten findet man es mit folgendem cmdlet:</p>  <p>Get-ChildItem cert:\CurrentUser\My –codesigning</p>  <p>Mit Set-AuthenticodeSignature wird ein Script signiert, dieses cmdlet benötigt zwei Parameter, das zu Signierende Script und das Zertifikat.</p>  <p>Im Folgenden Beispiel signiere ich die Datei C:\scripts\my-test.ps1 mit dem einzigen Zertifikat das in meinem Zertifikatsstore ist.</p>  <blockquote>   <p>$cert = Get-ChildItem cert:\CurrentUser\My –codesigning</p>    <p>Set-AuthenticodeSignature C:\scripts\my-test.ps1 $cert</p> </blockquote>  <p>Erscheint folgender Fehler, hat man das Script mit PowerShell ISE erstellt. Diese verwendet eine Codierung mit der Set-AuthenticodeSignature nicht zurechtkommt. Man erhält den vielsagenden Fehler: UnknonError.</p>  <p><a href="/assets/image_292.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_290.png" width="244" height="63" /></a></p>  <p>Um das Script trotzdem zu signieren erstellt man ein einfach eine neue Textdatei und speichert das Scripts mit notepad ab.</p>  <p><a href="/assets/image_293.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_291.png" width="244" height="43" /></a></p>  <p>Und schon ist das Script signiert.</p>  <p>Wenn man das Script jetzt auf einem Host ausführt auf dem die ExecutionPolicy auf AllSigned gesetzt ist wird man informiert dass der Herausgeber unbekannt ist. Das Zertifikat welches zum Signieren verwendet wurde muss im TrustedPublisher Zertifikatstore sein.</p>  <p><a href="/assets/image_294.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_292.png" width="244" height="37" /></a></p>  <p>Um das Zertifikat zu exportieren kann man die MMC Certficates verwenden, das Code Signing Zertifikat auswählen und auf Export klicken. Den Privat Key kann man nicht exportieren, dieser wird auch nicht benötigt um die Signatur zu bestätigen.</p>  <p>Die .cer Datei die man nach dem Export erhält kann man mit Gruppenrichtlinien auf alle Clients/Server verteilen oder manuell in den Store für Vertrauenswürdige Herausgeber importieren.</p>  <p>Gruppenrichtlinie:</p>  <p><a href="/assets/image_295.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_293.png" width="244" height="71" /></a></p>  <p>Nach dem nächsten GP Refresh läuft das Script ohne Fehlermeldung.</p>  <h4></h4>  <h4></h4>  <p>Wird ein Script verändert nachdem es signiert wurde, wird die Ausführung verhindert. Folgende Fehlermeldung erscheint.</p>  <p><a href="/assets/image_296.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/image_thumb_294.png" width="244" height="28" /></a></p>  <p>&#160;</p>  <p>tom</p>
