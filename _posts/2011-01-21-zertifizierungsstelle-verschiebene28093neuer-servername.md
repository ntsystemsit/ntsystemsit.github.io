---
layout: post
title: "Zertifizierungsstelle verschieben–neuer Servername"
date: 2011-01-21 23:51:21 +0100
comments: true
published: true
excerpt_separator: <!-- more -->
tags: ["Server"]
redirect_from: ["/post/Zertifizierungsstelle-verschiebene28093neuer-Servername", "/post/zertifizierungsstelle-verschiebene28093neuer-servername"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>In <a href="/post/Zertifizierungsstelle-verschieben-(BackupRestore).aspx">diesem Beitrag</a> habe ich beschrieben wie man eine Zertifizierungstele sichert, den alten Server abbaut und die CA auf einem neuen Server mit dem selben Namen wiederherstellt. </p>  <p>Will man allerdings die CA umziehen und den aktuellen Server nicht abbauen sind ein paar zusätzliche Schritte nötig. Wichtig ist hier zu sagen dass man zwar den Servernamen ändern kann, allerdings nicht den Namen der Zertifizierungsstelle!</p>  <p><strong>Tipp:</strong> Auch wenn die Microsoft Dokumentation das nicht wirklich bestätigt funktioniert eine Migration von 32Bit auf 64Bit. Also Backup auf x86 Restore auf x64 ist Möglich.</p>  <h4>Backup</h4>  <ol>   <li>Auf jeden Fall eine komplette Sicherung des Servers erstellen! </li>    <li>CA Datenbank und Key sichern </li>    <li>CA Konfiguration (Registry) sichern      <ol>       <li>Mit dem Registrierungseditor zu folgendem Schlüssel navigieren, rechtsklick und “Export” </li>        <li>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration </li>        <li>reg export HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration RegBackup.reg </li>     </ol>   </li>    <li>CA Templates notieren oder mit certutil.exe –catemplates &gt; templates.txt exportieren </li>    <li>CA Deinstallieren      <ol>       <li>Im Server Manager mit Remove Role die Active Directory Certificate Services deinstallieren </li>        <li>Achtung: wie bereits im alten Beitrag erwähnt bleiben gewisse Daten auf dem Server </li>     </ol>   </li> </ol>  <h4>Restore</h4>  <ol>   <li>alle Dateien (und Ordner) die von der Sicherung erstellt wurden auf den neuen Server kopieren      <ol>       <li>Achtung: caname.p12 enthält den private Key der CA! </li>     </ol>   </li>    <li>Private Key importieren      <ol>       <li>certutil –importpfx caname.p12 </li>     </ol>   </li>    <li>CA Dienste installieren      <ol>       <li>Server Manager          <ol>           <li>Im Servermanager mit Add Roles die Active Directory Certificate Services hinzufügen </li>            <li>Bei der Installation den richtigen CA Typ auswählen und das Richtige Zertifikat mit vorhandenem private Key wählen </li>         </ol>       </li>        <li>setupca.vbs          <ol>           <li>auf einem Core Server wird die CA am besten mit <a href="http://technet.microsoft.com/en-us/library/ee918754(WS.10).aspx">diesem</a> Script installiert </li>            <li>Bei der Installation muss der Wert im “Key Container” des installierten private Key angegeben werden, diesen kann man so herausfinden: certutil.exe -store my | find &quot;Key Container&quot; </li>            <li>setupca.vbs hat verschiedene Parameter um den entsprechenden CA Typ auszuwählen, folgendes Beispiel installiert eine Subordinate Enterprise CA: cscript setupca.vbs /IF /RC /SN WertKeyContainer </li>            <li>hier die Wichtigsten Parameter              <br />/IE – Enterprise Root CA Service               <br />/IS – Standalone Root CA Service               <br />/IF – Enterprise Subordinate CA Service               <br />/IT – Standalone Subordinate CA Service               <br />/RC – Reuse Certificate and Key               <br />/SN – CA Name </li>         </ol>       </li>     </ol>   </li>    <li>CA Datenbank wiederherstellen      <ol>       <li>dazu muss der Dienst certsvc gestoppt werden, net stop certsvc </li>        <li>Im Server Manager mit rechtsklick, Restore CA kann die Datenbank wiederhergestellt werden </li>        <li>mit certutil –f –restoreDB PfadZumDataBaseOrdner kann man dasselbe erreichen </li>     </ol>   </li>    <li>Konfiguration wiederherstellen: die Sicherung der Registry muss wieder importiert werden, dabei gilt es allerdings einiges zu beachten:      <ol>       <li>Backup der Registry auf dem neuen Server vor dem Import! </li>        <li>CAServerName anpassen, muss den neuen Servernamen enthalten </li>        <li>Die Pfade für folgende Werte kontrollieren, wenn sie auf dem alten Server nicht geändert wurden sollten kein Anpassungen nötig sein:          <ol>           <li>DBDirectory, DBLogDirectory, DBSystemDirectory, DBTempDirectory </li>         </ol>       </li>        <li>Den Inhalt für folgende Werte zu kontrollieren um sicherzustellen dass CDP und AIA Informationen richtig veröffentlicht werden          <ol>           <li>CACertPublicationURLs. CRLPublicationURLs </li>         </ol>       </li>        <li>Den Wert von CACertHash kontrollieren, wenn das CA Zertifikat erneuert wurde beinhaltet dieser Wert mehrere Thumbprints der CA Zertifikate. Wenn ein Thumbprint importiert wird und das zugehörige Zertifikat nicht installiert ist startet der Zertifikatsdienst (certsvc) nicht und protokollieret folgenden Fehler im Application Log:          <ol>           <li>Active Directory Certificate Services did not start: Could not load or verify the current CA certificate.&#160; CAName The system cannot find the file specified. 0x80070002 (WIN32: 2). </li>         </ol>       </li>     </ol>   </li>    <li>Berechtigungen auf CDP und AIA Container      <ol>       <li>Das Computerkonto des neuen Servers muss FullControl für die AIA und CDP Objekte des alten Server haben um CRLs und neue Root Zertifikate veröffentlichen zu können. </li>        <li>Berechtigungen werden mit ADSI Edit gesetzt, die Objekte finden sich unter CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local </li>     </ol>   </li> </ol>  <h4>Check</h4>  <p>Um zu überprüfen ob alles läuft kann man ein Zertifikat anfordern. Funktioniert das ausstellen der Zertifikate sollte man noch überprüfen ob der Zugriff auf die Sperrlisten funktioniert. Dazu Exportiert man das Zertifikat (in eine .cer Datei) und führt “certutil –url datei.cer” aus.</p>  <p>&#160;</p>  <p>tom</p>
