---
layout: post
title: "Microsoft NDES and Cisco IOS – part 2"
date: 2012-11-30 20:08:52 +0100
comments: true
published: true
excerpt_separator: <!-- more -->
categories: Archive
tags: ["Server 2012", "Network"]
redirect_from: ["/post/Microsoft-NDES-and-Cisco-IOS-part-2", "/post/microsoft-ndes-and-cisco-ios-part-2"]
author: thomas torggler
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>This is part two of my article about <a href="/post/Microsoft-NDES-and-Cisco-IOS-part-1.aspx" target="_blank">NDES and Cisco</a>. In the first article, I configured the Windows 2012 NDES role, in this part I will walk you through the enrollment process on a Cisco IOS router.</p>  <h2>RSA key</h2>  <p>So what are we going to do here? We will be leveraging SCEP to obtain a digital certificate from a CA. As a prerequisite to this, the router needs a key-pair, that is, private and public keys. The public key will be sent to the CA (using SCEP), the CA will sign that public key and send the certificate (signed public key) back to the router.</p>  <p>If you are already using services like “ssh” or “ip http secure-server” you can use the existing keys. If no keys exist, the router will create a new set of keys as we enroll for a certificate. This auto generated key-pair is only using a 512 bit key, that is not considered secure anymore.</p>  <p>To create a new key-pair, using a reasonable secure key length:</p>  <p><a href="/assets/image_478.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/image_thumb_476.png" width="244" height="48" /></a>&#160;</p>  <h2></h2>  <h2></h2>  <h2>Trustpoint</h2>  <p>Having the keys in place, we need to get the CA certificate. The router will use the CAs public key to authenticate the CA and other digital certificates issued by that same CA.</p>  <p>To download the CA certificate we define a new trustpoint and set to enrollment URL to the SCEP URL, if you have no name resolution configured, be sure to use the IP address of the SCEP server instead of the name.</p>  <p>The SCEP URL defaults to: http://servername:80/CertSrv/mscep/mscep.dll</p>  <p><a href="/assets/image_479.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/image_thumb_477.png" width="244" height="31" /></a> </p>  <p>After configuring the trustpoint, we tell the router to download the CA certificate:</p>  <p><a href="/assets/image_480.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/image_thumb_478.png" width="244" height="48" /></a> ´</p>  <p>IOS shows the Thumbprint (fingerprint) of the digital certificate, so one could verify that this is the correct certificate using an out-of-band method.</p>  <p>A quick look at the running-config shows that the key was received.</p>  <h2>Enroll</h2>  <p>Now that the router does trust our CA we can go ahead and request a digital certificate:</p>  <p><a href="/assets/image_481.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/image_thumb_479.png" width="244" height="91" /></a> </p>  <p>IOS prompts for a password that would be used to revoke the certificate, and you can choose to add the IP address or serial number to the certificate. </p>  <p>The request gets signed by the CA and the certificate is sent back to the router, you should see the following messages in the log or on “terminal monitor”</p>  <p>CRYPTO_PKI:&#160; Certificate Request Fingerprint MD5: 4C9C472F 605AA33F 869EB167 9F097C56    <br />CRYPTO_PKI:&#160; Certificate Request Fingerprint SHA1: E943141D 19A5C4EB 6B5EE5D2 B87AAF57 B829FFED     <br />%PKI-6-CERTRET: Certificate received from Certificate Authority</p>  <p>The IIS Log on the SCEP server shows the successful transaction like this:</p>  <p>2012-11-30 18:58:19 192.168.1.21 GET /CertSrv/mscep/mscep.dll/pkiclient.exe operation=PKIOperation&amp;message=MIIJUgYJKoZIhvcNAQcCoIIJQzCCCT8CAQExDjAMBggqhkiG…   <br />…2Bw6Q1AJGzQs4wl7jA4GvWvikdP1wnPzAkVP7KZ%2FZ1%2Fz4hCYNpP4%3D%0A 80 - 192.168.1.1 - - 200 0 0 277</p>  <p>In the “Certificate Authority” MMC Snap-In you see the certificates that have been issued:</p>  <p><a href="/assets/image_482.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/image_thumb_480.png" width="244" height="9" /></a> </p>  <p><a href="/assets/image_483.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/image_thumb_481.png" width="197" height="244" /></a> </p>  <p>&#160;</p>  <p>That was the second, and final part on NDES and IOS routers.</p>  <p>so long,</p>  <p>tom</p>
