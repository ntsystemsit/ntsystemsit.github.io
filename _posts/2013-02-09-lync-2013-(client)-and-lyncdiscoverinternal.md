---
layout: post
title: "Lync 2013 (Client) and LyncDiscoverInternal"
date: 2013-02-09 09:04:00 +0100
comments: true
published: true
excerpt_separator: <!-- more -->
tags: ["Lync", "Client"]
redirect_from: ["/post/Lync-2013-(Client)-and-LyncDiscoverInternal", "/post/lync-2013-(client)-and-lyncdiscoverinternal"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>Daniel and I have been quite busy implementing Lync 2013 these days. One interesting <strike>gotcha</strike> thing we knew, but didn’t give a lot attention about the Lync 2013 client is, that it makes use of the LyncDiscover and LyncDiscoverInternal DNS records. These records were introduced with Lync 2010 Mobility and were used by the mobile clients to locate a sign-in server. Lync 2010 Clients don’t look for them, they use _sipinternaltls._tcp and _sip._tls records for auto sign-in.</p>  <p>With the Lync 2013 Client that changed. The new client now queries for the following DNS records in order to sign-in automatically:</p>  <ol>   <li>LyncDiscoverInternal.ntsystems.it</li>    <li>LyncDiscover.ntsystems.it</li>    <li>_sipinternaltls._tcp.ntsystems.it</li>    <li>_sip._tls.ntsystems.it</li>    <li>sipinternal.ntsystems.it</li>    <li>sip.ntsystems.it</li>    <li>sipexternal.ntsystems.it</li> </ol>  <p><a href="/assets/image_493.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/image_thumb_491.png" width="244" height="62" /></a> </p>  <p>So, as you can see, even before trying to locate the SRV records, the 2013 Client tries to connect to the AutoDiscover Web Service. That works just fine, in most situations.</p>  <p>But… in a configuration like the following you might <strike>run into this bug</strike> get a certificate warning when signing into Lync for the first time from the internal network.</p>  <ol>   <li>You have a disparate namespace (like ntsystems.local for your Lync Servers while ntsystems.it is your SIP domain) AND</li>    <li>You use internal certificates on the Front End Servers AND</li>    <li>You have Split DNS configured (ntsystems.it on the internal DNS servers) AND</li>    <li>You set LyncDiscoverInternal.ntsystems.it DNS record (for public zone on internal DNS server)</li> </ol>  <p>The certificate warning shows the server name to which Lync is attempting to connect, it also shows the certificate subject and you can view the certificate. You double (triple) check the certificate, subject alternate names, dates, DNS, basically everything and it seems to be just fine. Still, you continue to get the warning.</p>  <h1>Workaround</h1>  <p>First of all, I have to say that I do not fully understand <strong>why</strong> this happens. The way I see it, is that Lync 2013 connects to the internal Web Service (using LyncDiscoverInternal) and all certificate parameters are fine… As you are probably not going to get a certificate for ntsystems.local from a public CA I wonder what the right solution looks like…</p>  <p>The good news: There is a workaround for this, you can use Group Policy to configure Lync 2013 to configure the Trusted Domain List. According to <a href="http://technet.microsoft.com/en-us/library/gg425941.aspx" target="_blank">TechNet</a>, this “Lists the trusted domains that do not match the prefix of the customer SIP domain.” – nice. So, I added ntsystems.local to the Trusted Domain List that can be found in User and Computer Configuration under: </p>  <blockquote>   <p>Administrative Templates/Microsoft Lync 2013/Microsoft Lync Feature Policies</p> </blockquote>  <p>You can download the <a href="http://www.microsoft.com/en-us/download/details.aspx?id=35554" target="_blank">admx/adml files for Office 2013 here</a>. The Group Policy adds the domain to the either “HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Office\15.0\Lync\TrustModelData” or “HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Office\15.0\Lync\TrustModelData” depending on what you choose in the Group Policy Object.</p>  <p><a href="/assets/image_494.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/image_thumb_492.png" width="244" height="47" /></a> </p>  <p>Another workaround would be to simply remove the LyncDiscoverInternal record from the internal DNS zone, which breaks mobile clients (including Lync Windows Store App) on the internal network (Wireless). Not really a solution…</p>  <p>Again, I don’t fully understand the problem, this is what I found during my research. If you have a better solution, please drop me a line :)</p>  <p>&#160;</p>  <p><a href="http://en.wikipedia.org/wiki/Chinese_New_Year" target="_blank">Happy New Year</a> and have a nice weekend,    <br />tom</p>
