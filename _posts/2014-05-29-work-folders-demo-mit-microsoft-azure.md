---
layout: post
title: "Work Folders Demo mit Microsoft Azure"
date: 2014-05-29 21:34:57 +0200
comments: true
category: Archive
tags: []
redirect_from: ["/post/Work-Folders-Demo-mit-Microsoft-Azure", "/post/work-folders-demo-mit-microsoft-azure"]
author: thomas torggler
---
<!-- more -->
<p>Vor einigen Tagen wollte ich in einer Demo das neue Windows Feature “Work Folders” zeigen, da ich gerade keine passende Umgebung hatte, habe ich kurzerhand zwei virtuelle Maschinen in Microsoft Azure IasS gestartet.</p> <h1>Übersicht</h1> <p>Da es sich um eine einfache Demo handelt verwende ich nur zwei Server die ich aus dem Windows 2012R2 Image in Azure erstelle. Auf dem ersten werden die Rollen Domain Controller, ADFS, Zertifizierungsstelle und Work Folders installiert, der zweite wird als Web Application Proxy für die Veröffentlichung verwendet.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_631.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_629.png" width="244" height="55"></a> </p> <p>Da die beiden Server miteinander kommunizieren sollen, verwende ich ein virtuelles Netzwerk in welches die beiden Server ausgerollt werden.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_632.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_630.png" width="244" height="203"></a> </p> <h1>Work Folders</h1> <p>Work Folders ist ein Feature von Windows 2012R2 und kann mit OneDrive/Dropbox verglichen werden. Work Folders bieten dem Benutzer eine einfache Möglichkeit auf Daten zuzugreifen und diese über mehrere Geräte zu synchronisieren. </p> <p>Leider gibt es derzeit nur Unterstützung für Windows 7 und 8/8.1, Clients für mobile Geräte wurden noch nicht angekündigt.</p> <p>Im ersten Schritt stufe ich den ersten Server zum Domain Controller hoch und installiere/konfiguriere die Zertifizierungsstelle. Eine spezielle Konfiguration dieser Rollen ist nicht notwendig, die einzige Anpassung ist das Erstellen eines neuen Zertifikattemplates welches später für die ADFS und WAP Zertifikate verwendet wird.</p> <h2></h2> <h2>DNS</h2> <p>Vor der Konfiguration der AD FS Rolle überlege ich mir einen Namen über welchen die Federation Services später erreichbar sein sollen, hier entscheide ich mich für adfs.uclab.eu. Damit ich interne Anfragen direkt zum AD FS Server leiten kann, erstelle ich ein DNS Zone für diesen Eintrag:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_633.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_631.png" width="244" height="191"></a> </p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_634.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_632.png" width="241" height="244"></a></p> <p>Der A-Record verweist auf meinen Domain Controller und AD FS Server.</p> <h2>AD FS</h2> <p>Nach der Installation der Active Directory Federation Services sind folgende Schritte für die Konfiguration notwendig.</p> <p>Ein Zertifikat mit dem Namen für die Federation Services sowie dem internen Servernamen wird angefordert. Hier verwende ich ein Kopie des WebServer Templates als Zertifikatsvorlage.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_635.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_633.png" width="244" height="244"></a> </p> <p>Sobald das Zertifikat installiert wurde, kann die AD FS Farm installiert werden, dafür wird der Thumbprint der Zertifikates benötigt, diesen kann man sich per PowerShell einfach anzeigen lassen:</p> <p><code>Get-ChildItem Cert:\LocalMachine\my -DnsName adfs*</code></p> <p>Außerdem wird ein Service Account für den AD FS Dienst benötigt, dafür verwende ich ein normales AD User Account. Jetzt kann die Farm installiert werden, dabei wird das Service Account mit Get-Credential abgefragt:</p> <p><code>Install-ADFSFarm -CertificateThumbprint 9EA51F4DAA939C077602DF0B7EE7426F61E2DE0A -FederationServiceDisplayName "Uclab Demo" –FederationServiceName adfs.uclab.eu -OverwriteConfiguration -ServiceAccountCredential (Get-Credential) -ErrorAction Stop </code></p> <p>In der AD FS Management Konsole sehen die Federation Service Properties folgendermaßen aus:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_636.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_634.png" width="219" height="244"></a>&nbsp;</p> <h2>AD FS Relying Trust</h2> <p>Jetzt wird ein Relying Party Trust hinzugefügt, dazu klickt man in der AD FS Management Konsole mit rechts auf “AD FS” und wählt “Add Relying Party Trust”.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_637.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_635.png" width="244" height="198"></a> </p> <p>Die Daten müssen manuell eingegeben werden, ein Name wird für den Trust gewählt.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_638.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_636.png" width="244" height="198"></a> </p> <p>Das AD FS Profil wird verwendet, die Auswahl des Zertifikates für Token Signierung sowie die Konfiguration der URLs für WS-Federation und SAML können übersprungen werden.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_639.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_637.png" width="244" height="198"></a></p> <p>Als Identifikation muss “https://windows-server-work-folders/V1” verwendet werden. Multi Faktor Authentifizierung ist in meiner Demo nicht nötig und wird auch übersprungen.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_640.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_638.png" width="244" height="198"></a> </p> <p>Der letzte Schritt kann auch übersprungen werden, anschließend wird der Trust erstellt. Jetzt müssen noch “Claim Rules” definiert werden.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_641.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_639.png" width="244" height="198"></a> </p> <p>Folgende Attribute werden definiert:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_642.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_640.png" width="244" height="198"></a> </p> <p>Jetzt müssen per PowerShell noch folgende Eigenschaften konfiguriert werden:</p> <p><code>Set-ADFSRelyingPartyTrust -TargetIdentifier “<a href="https://windows-server-work-folders/V1&rdquo;">https://windows-server-work-folders/V1”</a> -EnableJWT:$true <br>Set-ADFSRelyingPartyTrust -TargetIdentifier “<a href="https://windows-server-work-folders/V1&rdquo;">https://windows-server-work-folders/V1”</a> –Encryptclaims:$false <br>Set-ADFSRelyingPartyTrust -TargetIdentifier “<a href="https://windows-server-work-folders/V1&rdquo;">https://windows-server-work-folders/V1”</a> -AutoupdateEnabled:$true <br>Set-ADFSRelyingPartyTrust -TargetIdentifier “<a href="https://windows-server-work-folders/V1&rdquo;">https://windows-server-work-folders/V1”</a> -IssueOAuthRefreshTokensTo:’AllDevices’</code></p> <p>Der AD FS Server ist jetzt soweit bereit für die Authentifizierung der Work Folders.</p> <h2>File and Storage Services: Work Folders</h2> <p>Jetzt kann die Work Folders Rolle installiert werden, das geht am schnellsten per PowerShell:</p> <p><code>Install-WindowsFeature –Name FS-SyncShareService</code></p> <p>Nach der Installation erfolgt die Konfiguration der Work Folders über den Server Manager, die Konfiguration ist (wie die Server Rolle) unter “File and Storage Services” zu finden.</p> <p>Ein neuer “Sync Share” wird angelegt, hier wird ein lokaler Pfad für die synchronisierten Daten angegeben.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_643.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_641.png" width="244" height="180"></a> </p> <p>Anschließend wird ausgewählt wie die Ordner auf dem Server benannt werden sollen:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_644.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_642.png" width="244" height="180"></a> </p> <p>Dann können die Berechtigungen vergeben werden, Standardmäßig wird die NTFS Vererbung unterbrochen und der Benutzer erhält exklusiven Zugriff auf sein Sync Share.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_645.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_643.png" width="244" height="180"></a> </p> <p>Über Client Richtlinien kann geregelt werden ob die Work Folder Dateien lokal verschlüsselt werden müssen und ob das Gerät mit einem Passwort gesperrt wird.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_646.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_644.png" width="244" height="180"></a> </p> <p>Nachdem der Sync Share erstellt wurde, muss die Authentifizierung auf ADFS geändert werden, dazu muss man im Server Manager auf Server klicken und den lokalen Server auswählen, dann kann mit einem Rechtsklick “Work Folders Settings” ausgewählt werden:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_647.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_645.png" width="244" height="151"></a></p> <p>Ich gebe die vorher erstellte AD FS Farm für Authentifizierung an. </p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_648.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_646.png" width="244" height="197"></a> </p> <h1>Web Application Proxy</h1> <p>Jetzt ist es an der Zeit den Reverse Proxy auf meinem zweiten Server zu installieren, dieser ist nicht Mitglied der AD Domain, die Authentifizierung erfolgt über AD FS.</p> <p>Noch auf dem Domain Controller fordere ich ein Zertifikat für den Proxy an, hier verwende ich wieder den Namen der AD FS Farm sowie einen weiteren Namen über den ich die Work Folders veröffentlichen werde:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_649.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_647.png" width="244" height="244"></a> </p> <p>Dieses Zertifikat exportiere ich am Domain Controller und importiere es auf dem Reverse Proxy, da dieser nicht Mitglied der Domain ist, muss auch das Root Zertifikat importiert werden.</p> <p>Jetzt kann die Rolle Web Application Proxy installiert werden, diese geht wieder am schnellsten per PowerShell:</p> <p><code>Install-WindowsFeature –Name Web-Application-Proxy</code></p> <p>Anschließend wird die Rolle konfiguriert, dafür kann die “Remote Access Management Console” verwendet werden, da sich diese aber nach pre-Beta anfühlt bevorzuge ich auch hier PowerShell. Ein guter Tipp für unbekannte oder selten verwendete cmdlets ist “Show-Command” so kann man sich seinen Befehl einfach zusammenstellen:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_650.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_648.png" width="244" height="131"></a> </p> <p>Der Befehl für die Konfiguration des Web Application Proxy ist dann:</p> <p><code>Install-WebApplicationProxy -CertificateThumbprint 9D082F66864E3BD9A575AC429BA12130E89CFEE2 -FederationServiceName adfs.uclab.eu -FederationServiceTrustCredential (Get-Credential)</code></p> <p>Nun kann die Work Folder Applikation erstellt werden, auch dafür verwende ich wieder “Show-Command” um den PowerShell Befehl zu erstellen.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_651.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_649.png" width="223" height="244"></a></p> <p>Der Befehl für das veröffentlichen der Applikation ist:</p> <p><code>Add-WebApplicationProxyApplication -BackendServerUrl <a href="https://wfdemo.intra.uclab.eu">https://wfdemo.intra.uclab.eu</a> -ExternalCertificateThumbprint 9D082F66864E3BD9A575AC429BA12130E89CFEE2 -ExternalUrl <a href="https://workfolders.uclab.eu">https://workfolders.uclab.eu</a> -Name WorkFolders -ADFSRelyingPartyName WorkFolders -ExternalPreauthentication ADFS –UseOAuthAuthentication</code></p> <p>Nachdem die Applikation über den WAP veröffentlich wurde, muss diese nur noch von außen erreichbar gemacht werden. Dazu werden in der öffentlichen DNS Zone zwei CNames erstellt, einen für die AD FS Farm den anderen für den Namen der Work Folders. Diese CNames zeigen auf den Cloud Service der Reverse Proxy VM in Microsoft Azure.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_652.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_650.png" width="244" height="67"></a> </p> <p>Der Reverse Proxy bekommt einen HTTPS Endpunkt und wird somit erreichbar gemacht:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_653.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_651.png" width="244" height="64"></a> </p> <h1></h1> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <h1>DEMO</h1> <p>Nach all diesen Schritten wird es Zeit die AD FS Authentifizierung zu testen, dazu kann folgende URL verwendet werden:</p> <p><code><a href="https://adfs.uclab.eu/adfs/ls/idpinitiatedsignon.htm">https://adfs.uclab.eu/adfs/ls/idpinitiatedsignon.htm</a></code></p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_654.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_652.png" width="244" height="165"></a> </p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_655.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_653.png" width="244" height="165"></a> </p> <p>Das sieht schon mal gut aus, also können wir die Work Folders testen, diese finden sich in der Systemsteuerung:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_656.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_654.png" width="244" height="150"></a> </p> <p>Die URL für die veröffentlichte Applikation wird angegeben, es gibt die Möglichkeit diese in der Registry oder einem AD Attribut für Auto Discovery zu hinterlegen, beide Varianten sind aber nur auf Domain Clients interessant.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_657.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_655.png" width="244" height="150"></a> </p> <p>Für die Anmeldung werde ich auf AD FS umgeleitet:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_658.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_656.png" width="244" height="201"></a> </p> <p>Dann kann ich einen lokalen Speicherort auswählen und werde auf die Richtlinien hingewiesen:</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_659.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_657.png" width="244" height="129"></a> <a href="http://uclab.azurewebsites.net/assets/archive/image_660.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_658.png" width="244" height="129"></a> </p> <p>In der Übersicht sieht man Status der Synchronisation und den verfügbaren Speicherplatz am Server.</p> <p><a href="http://uclab.azurewebsites.net/assets/archive/image_661.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="http://uclab.azurewebsites.net/assets/archive/image_thumb_659.png" width="244" height="129"></a> </p> <p>Viel Spaß mit den Work Folders und ein schönes, langes Wochenende :)</p> <p>Tom</p>
{% include imported_disclaimer.html %}
