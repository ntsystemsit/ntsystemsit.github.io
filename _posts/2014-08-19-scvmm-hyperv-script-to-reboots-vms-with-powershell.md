---
layout: post
title: "SCVMM–HyperV Script to reboots VM’s with powershell"
date: 2014-08-19 18:07:58 +0200
comments: true
published: true
categories: ["blog", "archives"]
excerpt_separator: <!-- more -->
tags: []
alias: ["/post/SCVMM-HyperV-Script-to-reboots-VMs-with-powershell.aspx", "/post/scvmm-hyperv-script-to-reboots-vms-with-powershell.aspx"]
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>Today I wondered that with Hyper-V there is no option to „reboot“ a VM with right clicking on it. With ESX I have the option to reboot the guest and so I created a script to schedule the reboot with the help of VMWare Powershell and VMWare tools.   <br />The Hyper-V modules on SCVMM gives you the option to shut down and start a VM. Therefore I wrote a simple script that shutdown all VM machines in a specified list (you can use an argument if you want to work with multiple lists). </p>  <p>The shutdown is initiated with the “-RunAsynchronously“ switch so that the Powershell command does not wait until the vm is powered off. Immediately after sending the shutdown command a “do while” loop begins to work and waits until one of the machines is powered off. If a machine is switched off the loop powers the VM machine on. The loop ends when all machines are started up.</p>  <p>As I have also a VMWare vCenter connected in SCVMM I only touch VM machines with a filter: VirtualizationPlatform = “HyperV”   <br /></p>  <p>&#160;</p>  <p># Import Module   <br />Import-Module -Name &quot;virtualmachinemanager&quot;</p>  <p># Clear Variables   <br />[String[]] $VMsToStart = $Null</p>  <p># Get List of VM's to reboot   <br />$VMsToReboot = Get-Content &quot;C:\Program Files\Scripts\ServerList.txt&quot;</p>  <p># Shutdown each VM   <br />Foreach($VMToShutdown in $VMsToReboot){    <br />&#160;&#160;&#160; $VMToShutdownObject = Get-SCVirtualMachine $VMToShutdown    <br />&#160;&#160;&#160; If ($VMToShutdownObject -ne $Null){    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; If($VMToShutdownObject.VirtualizationPlatform -eq &quot;HyperV&quot; -and $VMToShutdownObject.VirtualMachineState -eq &quot;Running&quot;){    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Shutdown-VM -VM $VMToShutdownObject -RunAsynchronously    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $VMsToStart += $VMToShutdown    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }Else{    <br />&#160;&#160;&#160; Write-Verbose (&quot;Machine &quot; + $VMToShutdown + &quot; not found&quot;)    <br />&#160;&#160;&#160; }    <br />}</p>  <p># Start each VM after graceful shutdown   <br />Do{    <br />&#160;&#160;&#160; ForEach($VMToStart in $VMsToStart){    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; $VMToStartObject = Get-SCVirtualMachine $VMToStart    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; If($VMToStartObject.VirtualMachineState -eq &quot;PowerOff&quot;){    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Start-VM -VM $VMToStartObject -RunAsynchronously    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; $VMsToStart = $VMsToStart | ? {$_ -ne $VMToStart}    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }    <br />}while($VMsToStart.Count -ne 0)    </p>
