---
layout: post
title: "Netscaler as ADFS Proxy"
date: 2015-09-28 19:30:00 +0200
comments: true
published: true
excerpt_separator: <!-- more -->
categories: Archive
tags: ["ADFS", "Citrix", "en"]
redirect_from: ["/post/Netscaler-as-ADFS-Proxy", "/post/netscaler-as-adfs-proxy"]
author: daniel nitz
---
<!-- more -->
{% include imported_disclaimer.html %}
<p>I decided to use Netscaler to publish my ADFS server to the internet instead of a dedicated server in the DMZ. I checked several blogs and the official Citrix documentation but this looked overloaded. </p> <p>Citrix documentation: <a title="NetScaler as ADFS Proxy Deployment Guide - Citrix" href="https://www.google.de/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CCAQFjAAahUKEwi1ode5tZrIAhXH8nIKHW3HAmo&amp;url=https%3A%2F%2Fwww.citrix.com%2Fcontent%2Fdam%2Fcitrix%2Fen_us%2Fdocuments%2Fproducts-solutions%2Fguide-to-deploying-netscaler-as-an-active-directory-federation-services-proxy.pdf&amp;usg=AFQjCNGPU90qksKh6tD0Ou_Hyg9rxlLGBQ&amp;bvm=bv.103388427,d.bGQ">NetScaler as ADFS Proxy Deployment Guide - Citrix</a><br>Blogs: <a title="http://blogs.citrix.com/2015/05/29/adfs-v3-on-windows-server-2012-r2-with-netscaler/" href="http://blogs.citrix.com/2015/05/29/adfs-v3-on-windows-server-2012-r2-with-netscaler/">http://blogs.citrix.com/2015/05/29/adfs-v3-on-windows-server-2012-r2-with-netscaler/</a>, <a title="http://cividan.blogspot.it/2015/02/use-citrix-netscaler-as-replacement-for.html" href="http://cividan.blogspot.it/2015/02/use-citrix-netscaler-as-replacement-for.html">http://cividan.blogspot.it/2015/02/use-citrix-netscaler-as-replacement-for.html</a></p> <p>So I searched a way to:</p> <p>- Publish ADFS to the Internet with URL filter<br>- Do not pre-authenticate with Netscaler (Customizing multiple pre-authentication Websites can be very time consuming per tenant)<br>- Modify the Header that ADFS server understands the request comes from external</p> <p>There was no blog post that explained the whole configuration, so I decided to write down the required steps:</p> <p><strong>1. The service</strong></p> <p>First create the service and specify to forward the Client IP (Header: X-MS-Forwarded-Client-IP)</p> <p><a href="/assets/image_675.png"><img width="370" height="289" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_673.png" border="0"></a></p> <p>&nbsp;</p> <p><strong>2. The vServer</strong>&nbsp;</p> <p>Create the vServer not directly addressable to not trash an IP address and bind the certificate</p> <p><a href="/assets/image_676.png"><img width="371" height="238" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_674.png" border="0"></a></p> <p><strong>3. Content switch policy</strong></p> <p>Create a content switch policy to forward only /adfs and the exact hostname to the vServer</p> <p><a href="/assets/image_677.png"><img width="373" height="175" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_675.png" border="0"></a></p>  <p><strong>4. Content Switch vServer</strong></p> <p>Create the content switch vServer and apply the content switch policy</p> <p><a href="/assets/image_678.png"><img width="369" height="229" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_676.png" border="0"></a></p> <p><strong>5. Rewrite Actions</strong></p> <p>You want to let the ADFS know that the request comes from extranet. So you can apply different authentication methods in the different zones. You have to add the header X-MS-Proxy to the request. Therefore you create a rewrite action</p> <p><a href="/assets/image_679.png"><img width="356" height="335" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_677.png" border="0"></a></p> <p>Create also a rewrite action to rewrite URL /mex </p> <p><a href="/assets/image_680.png"><img width="351" height="183" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_678.png" border="0"></a></p> <p><strong>6. Rewrite Policy</strong></p> <p><a href="/assets/image_681.png"><img width="350" height="356" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_679.png" border="0"></a></p> <p><a href="/assets/image_682.png"><img width="345" height="315" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_680.png" border="0"></a></p> <p><strong>7. Bind the Policies</strong></p> <p>Now bind the policies to the vServer. Both are rewrite policies for requests. Be careful with the GoTo expression to the Header transformation, this must be “NEXT”</p> <p><a href="/assets/image_686.png"><img width="617" height="134" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_684.png" border="0"></a></p> <p><strong>8. The Monitor</strong></p> <p>ADFS has a probe check build in. If you check /adfs/probe you get a 200 message if everything is OK. Create the monitor and add it to the service</p>        <p><a href="/assets/image_684.png"><img width="265" height="339" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_682.png" border="0"></a></p> <p>&nbsp;</p> <p>Netscaler configuration is done. You can test now the authentication if you access the URL <a href="https://portal.office.com">https://portal.office.com</a> through Netscaler. Then you will be redirected to the ADFS website for authentication:</p> <p><a href="/assets/image_685.png"><img width="438" height="156" title="image" style="border: 0px currentColor; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" alt="image" src="/assets/image_thumb_683.png" border="0"></a></p> <p>For internal requests use split DNS to forward the authentication directly to the ADFS server and not to the Netscaler ADFS proxy. So the Proxy Header is missing and your client will use internal authentication.</p> <p>Stay tuned for my post series about configuring Exchange in Hybrid mode with Office 365.</p> <p>Greetings<br>ND</p>
