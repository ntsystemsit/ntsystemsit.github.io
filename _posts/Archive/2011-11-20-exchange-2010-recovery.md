---
layout: post
title: "Exchange 2010–Restore Mailbox Content"
date: 2011-11-20 19:37:28 +0100
comments: true
category: Archive
tags: ["Exchange"]
redirect_from: ["/post/Exchange-2010-Recovery", "/post/exchange-2010-recovery"]
author: thomas torggler
---
<!-- more -->
<p>Nachdem die Exchange Datenbank <a href="/post/Exchange-2010-e28093-Backup.aspx" target="_blank">erfolgreich gesichert</a> wurde, sollte man sich den Recovery Vorgang mal genauer anschauen.</p>  <p>Man kann jetzt einzelne Elemente oder ganze Mailboxen löschen um diese vom Backup wieder zurück zu holen. Zwar gibt es mit Single Item Recovery eine bessere Möglichkeit für das Widerherstellen einzelner Mails, dazu aber ein anderes mal mehr.</p>  <h1>Restore Files</h1>  <p>Die Datenbank wird von der Sicherung zurück geholt, dazu starte ich Windows Backup und wähle Recovery. Ich kann nun aus den erstellten Backups wählen und entscheide mich für eines auf einem Netzlaufwerk.</p>  <p>&#160;<a href="/assets/archive/image_367.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" class="wlDisabledImage" title="image" border="0" alt="image" src="/assets/archive/image_thumb_365.png" width="244" height="191" /></a><a href="/assets/archive/image_368.png"><img style="border-right-width: 0px; margin: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" class="wlDisabledImage" title="image" border="0" alt="image" src="/assets/archive/image_thumb_366.png" width="244" height="192" /></a></p>  <p>Nun kann ich wählen was ich Wiederherstellen möchte, in meinem Fall einzelne Dateien oder Ordner. Ich hole mir also die .edb Datei (Datenbank) und den kompletten Log Folder derselben zurück. Das Ganze darf natürlich nicht an der ursprünglichen Stelle widerhergestellt werden, sondern in einem neuen Ordner.</p>  <h1>Recovery Database</h1>  <p>Ist die Wiederherstellung abgeschlossen wird mit der Exchange Management Shell eine Recovery Database erstellt, diese verwendet die wiederhergestellte .edb Date sowie die wiederhergestellten Log Files. </p>  <p>Dieses Beispiel erstellt die Recovery Database RDB01 auf dem Server MBX01, X:\restore ist dabei der Ort an dem die Edb Datei und der Log Ordner wiederhergestellt wurden.</p>  <p><code>New-MailboxDatabase <em>RDB01 –Recovery –</em>Server <em>MBX01 –</em>EdbFilePath <em>x:\restore\db.edb</em> –LogFolderPath <em>x:\restore</em> </code></p>  <p><em></em></p>  <p>Die Datenbank wurde also erstellt, allerdings wird man darauf hingewiesen dass die Datenbank noch nicht gemounted wurde, sie muss erst in einen “Clean Shutdown State” gebracht werden.</p>  <p><a href="/assets/archive/image_369.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" class="wlDisabledImage" title="image" border="0" alt="image" src="/assets/archive/image_thumb_367.png" width="644" height="23" /></a></p>  <h1>Eseutil</h1>  <p>Um die Datenbank in einen sauberen Status zu bringen wird eseutil.exe verwendet. Dabei ist es wichtig die richtigen Parameter zu verwenden.</p>  <p>Als erstes kann man überprüfen in welchen Zustand sich die Datenbank befindet:</p>  <p><code>Eseutil /mh x:\restore\db.edb</code></p>  <p><a href="/assets/archive/image_370.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="/assets/archive/image_thumb_368.png" width="244" height="39" /></a></p>  <p>Die Datenbank ist also im “Dirty Shutdown” State und kann so nicht gemounted werden, mit “eseutil /r” wird die DB ohne Datenverlust in einen “Clean Shutdown” State gebracht. Mit dem Parameter /r wird der Präfix der Logs angegeben, also am besten zuerst den Dateinamen den Logs überprüfen. Die Parameter /l und /d geben den Pfad zu den Logs&#160; bzw. zur Datenbank an.</p>  <p><code>Eseutil /r “E01” /l x:\restore\ /d x:\resotre</code></p>  <p><strong>Achtung:</strong> Sollte das nicht funktionieren kann mit eseutil /p ein Hard Repair durchgeführt werden, dabei wird die Datenbank ohne Rücksicht auf Verluste in den “Clean Shutdown” State gebracht. <strong>Datenverlust</strong> ist möglich!</p>  <p>Nachdem Eseutil durchgelaufen ist und sich die Datenbank im Clean Shutdown State befindet kann sie gemounted werden, das geht in der EMC mit einem Rechtsklick auf die RDB oder mit der Management Shell und folgendem Befehl:</p>  <p><code>Mount-Database RDB01</code></p>  <h1>Mailbox Restore Request</h1>  <p>Wenn die Recovery Database online ist kann man beginnen Mailbox Inhalte wiederherzustellen, dazu verwendet man das cmdlet New-MailboxResotreRequest. Folgendes Beispiel stellt den Inhalt der Mailbox “Test User” in den Ordner Restore derselben Mailbox wieder her.</p>  <p><code>New-MailboxRestoreRequest –SourceDatabase ‘RDB01’ –SourceStoreMailbox ‘test user’ –TargetMailbox ‘test.user@ntsystems.it’ –TargetRootFolder ‘Restore’</code></p>  <p>Folgendes Beispiel stellt den Inhalt aller Mailboxen der Datenbank DB01 wieder her. Es wird für jede Mailbox ein Restore Request erstellt, auch hier wird der Inhalt in den Ordner Restore der jeweiligen Mailbox wiederhergestellt.</p>  <p><code>Get-Mailbox –Database ‘DB01’ |foreach { New-MailboxRestoreRequest -SourceStoreMailbox $_.Guid –SourceDatabase ‘RDB01’ -TargetMailbox $_.Guid –TargetRootFolder ‘Restore’}</code></p>  <p>Bei diesem cmdlet ist zu beachten dass die Parameter –SourceStoreMailbox und -TargetMailbox verschiedene Eingaben unterstützen, am Besten die Mailbox GUID verwenden, diese wird von beiden unterstützt.</p>  <p>Weitere Infos zu New-MailboxRestoreRequest gibt es im TechNet: <a title="http://technet.microsoft.com/en-us/library/ff829875.aspx" href="http://technet.microsoft.com/en-us/library/ff829875.aspx">http://technet.microsoft.com/en-us/library/ff829875.aspx</a>&#160;</p>  <h1>Cleanup</h1>  <p>Wenn der Restore Vorgang abgeschlossen ist kann man die Recovery Database wieder entfernen, dazu muss sie zuerst mit folgendem Befehl dismounted werden:</p>  <p><code>Dismount-Database RDB01</code></p>  <p>Anschließend kann man die RDB löschen, dazu verwendet man folgenden Befehl:</p>  <p><code>Remove-MailboxDatabase RDB01</code></p>  <p>Die Datenbank ist jetzt aus der Konfiguration entfernt, die Files sind jedoch nach wie vor auf dem Server. Diese müssen manuell gelöscht werden.</p>  <p>&#160;</p>  <p>so long,   <br />tom</p>
{% include imported_disclaimer.html %}
