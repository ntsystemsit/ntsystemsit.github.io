---
layout: post
title: "CNG Certificates and Lync/ TMG"
date: 2013-10-29 20:30:51 +0100
comments: true
category: Archive
tags: ["en", "Lync", "Skype4B"]
redirect_from: ["/post/CNG-Certificates-and-Lync-TMG", "/post/cng-certificates-and-lync-tmg"]
author: thomas torggler
---
<!-- more -->
<p>The other day I had a problem assigning certificates to a Lync 2013 Edge Server, today I had the same thing with TMG 2010. Here’s a quick summary, and the solution ;)</p>  <h1>Problem</h1>  <p>I tried to assign an existing certificate to a Lync Edge Server. It did not work using the Deployment Wizard, I tried the PowerShell command and it didn’t work, either.</p>  <p>Every time I tried to “Set-CsCertificate” I would get the following error:</p>  <p><code>„Set-CsCertificate: Command execution failed: The buffer supplied to a Function was too small.”</code></p>  <p>Kind of the same thing happened with TMG Server, I tried to assign a certificate to a Web Listener and it would not show up in the Wizard. When I unchecked the “Show only valid Certificates” checkbox, the certificate in question would show with an Error saying:</p>  <p><code>“Incorrect Key Type”</code></p>  <h1>Solution</h1>  <p>The solution is to export the certificate, including private key, to a .pfx file. Copy the .pfx file to some workstation with Firefox installed and import the certificate in Firefox.</p>  <p><a href="/assets/archive/image_601.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="/assets/archive/image_thumb_599.png" width="233" height="244" /></a> </p>  <p>Now use Firefox to “backup” the certificate, this will create a .p12 file, again containing the private key. Copy the .p12 file back to the Server delete the existing certificate and then import the .p12 file using MMC Certificates.</p>  <p><strong>Warning: </strong>Before deleting the certificate from the Server, make sure you have a working backup (like the .pfx file) or you will have to get a new one.</p>  <p>Try to assign the Certificate to a Lync Service or a TMG Web Listener and enjoy.</p>  <p>I realize that this sounds pretty silly at first, if you want more detail, keep on reading :)</p>  <h1>Background</h1>  <p>If you are still reading, there is a little more information for you. The certificates in question were using something called “Cryptography Next Generation”, which seems to be some new set of APIs that was introduced in Windows Vista and Server 2008. When creating a custom certificate request, one can select the “Template” to use, this is not the certificate template, but the “Crypto Provider” if you will.</p>  <p><a href="/assets/archive/clip_image001_8.png"><img title="clip_image001" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="clip_image001" src="/assets/archive/clip_image001_thumb_7.png" width="244" height="95" /></a></p>  <p>The certificates that I mentioned, have all been requested using the CNG Template. Importing/ Exporting them in Firefox seems to fix this, maybe because Firefox prefers CAPI over CNG? If you have any information on this topic, please leave a comment.</p>  <h1></h1>  <p>More info on Crypto Next Generation is available on TechNet: <a title="http://technet.microsoft.com/en-us/library/cc730763(WS.10).aspx" href="http://technet.microsoft.com/en-us/library/cc730763(WS.10).aspx">http://technet.microsoft.com/en-us/library/cc730763(WS.10).aspx</a></p>  <p>Cheers,   <br />tom</p>
{% include imported_disclaimer.html %}
