---
layout: post
title: "Lync: SIP inter-domain federation with Cisco Unified Presence - 1"
date: 2014-03-03 19:29:59 +0100
comments: true
category: Archive
tags: ["en", "Lync"]
redirect_from: ["/post/Lync-SIP-inter-domain-federation-with-Cisco-Unified-Presence-1", "/post/lync-sip-inter-domain-federation-with-cisco-unified-presence-1"]
author: thomas torggler
---
<!-- more -->
<p>As a consultant I do have the pleasure to be working with new customers on a regular basis. Recently I had the interesting request to make Lync 2013 talk to a Cisco Unified Presence 9.1 server. The goal for the customer was, to provide Lync users with the presence information available in the Cisco world.</p>  <p>Luckily the configuration was setup with multiple domains, Lync using the public (tomt.it) and Cisco Unified Presence using an internal only (tomt.local) domain. </p>  <h1>What’s possible?</h1>  <p>Before you get your hopes to high, here goes a quick list of what functionality will be available, once the federation is in place.</p>  <ul>   <li>Presence </li>    <li>Contact List (users from both domains can add each other) </li>    <li>IM (Peer to Peer only) </li> </ul>  <p>That’s it. Sure you can use Jabber to make your Cisco Desk Phone call a Lync endpoint, if you have a SIP trunk configured between the two systems, but that’s got nothing to do with the presence federation.</p>  <h1>Basic Topology</h1>  <p>The topology I was working with, consisted of a single Lync 2013 Standard Edition Front End Server with an associated Edge server. Lync was completely configured and operational, the SIP domain I’m going to use in this example is: @tomt.it</p>  <p>The Cisco Unified Presence Server was a standalone box, too. It was hooked up to a clustered CUCM installation, though that should not matter in this example. The SIP domain on the CUPS was @tomt.local</p>  <p>All of my test VMs are located in the 10.1.1.0/24 subnet.</p>  <h1>CUPS configuration</h1>  <p>There are a couple of requirements on the Cisco side of things. First let’s talk certificates.</p>  <p>The recommended configuration uses TLS as transport for the federation, not only is it more secure, it’s interesting enough that it’s easier to setup, too.</p>  <p>So we need a certificate on the Unified Presence server, to complete this step, log in to the “OS Administration” website of the CUP Server, to connect to the OS Administration website, use /cmplatform.</p>  <p><a href="/assets/archive/image_621.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_619.png" width="244" height="55" /></a> </p>  <p>Once signed-in, go to Security, Certificate Management and: </p>  <ol>   <li>Import the internal certification authority’s certificate to CUPS. Select the Type: “cup-trust” </li>    <li>Create a new certificate signing request (CSR). Select the Type: “cup” </li>    <li>Issue the certificate using a template that uses Server Authentication <strong>and </strong>Client Authentication as “Enhanced Key Usage”. Note: You’ll need a CA running on Windows Server Enterprise Edition for that, the default WebServer template does not include Client Authentication. </li>    <li>Import the issued certificate on the CUPS. Select the Type: “cup” </li> </ol>  <p>After that, my Certificate Management looked like this:</p>  <p><a href="/assets/archive/image_622.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_620.png" width="244" height="96" /></a> </p>  <p>The next step is setting up the SIP Federation, this requires you to log-in to the “IM and Presence Administration” website, it can be found at /cupadmin.</p>  <p>Using <strong>Presence</strong>, <strong>Inter-Domain Federation</strong>, <strong>SIP Federation</strong>, <strong>Federated Domain</strong> we add the Lync Servers SIP Domain (tomt.it) as inter-domain federation:</p>  <p><a href="/assets/archive/clip_image001_9.png"><img title="clip_image001" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image001" src="/assets/archive/clip_image001_thumb_8.png" width="244" height="95" /></a></p>  <p><strong>Note:</strong> Some documentation state that you need to check the “Direct Federation” box, I found that it will work either way. If someone with CUP knowledge reads this, please do get in touch.</p>  <p>The next step is setting up a static route from the CUP Server to Lync. This is done using the <strong>Presence</strong>, <strong>Routing</strong>, <strong>Static Routes</strong> menu. We configure a destination pattern with an associated next hop and transport protocol, do note the notation used for the destination pattern!</p>  <p><a href="/assets/archive/image_623.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_621.png" width="244" height="135" /></a> </p>  <p><strong>Important: </strong>Select TLS as “Protocol Type” and User as the “Route Type”. 5061 is the default port on which a Lync Server will listen for TLS requests.</p>  <p>While we are in the “IM and Presence Administration” there are another couple of things to configure:</p>  <p>The Lync Servers FQDN (i.e the Common Name on the Lync Pools Certificate) must be added as TLS Peer Subject using <strong>System</strong>,<strong> Security</strong>, <strong>TLS Peer Subjects</strong>:</p>  <p><a href="/assets/archive/clip_image001%5B4%5D.png"><img title="clip_image001[4]" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image001[4]" src="/assets/archive/clip_image001%5B4%5D_thumb.png" width="244" height="61" /></a></p>  <p>Then, using <strong>System</strong>, <strong>Security</strong>, <strong>Peer Auth Security Context</strong> add the newly created TLS Peer Subject:</p>  <p><a href="/assets/archive/image_624.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="image" src="/assets/archive/image_thumb_622.png" width="244" height="180" /></a> </p>  <p>Also make sure to check the “Disable Empty TLS Fragments” box and add the TLS_RSA_WITH_3DES_EDE_CBS_SHA cipher to selected ciphers.</p>  <p>Still in <strong>System</strong>, <strong>Security </strong>we need to configure ACLs. The ACLs are not traditional ACLs which allow or block IP:Port combinations, these are used to configure whether or not a communication partner has to be authenticated using MD5. Neither Lync Servers nor Lync Clients support SIP Digest authentication using MD5, so we need to make sure that they will not be prompted for authentication:</p>  <p>The following show my incoming and outgoing ACL entries:</p>  <p><a href="/assets/archive/clip_image001%5B6%5D.png"><img title="clip_image001[6]" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image001[6]" src="/assets/archive/clip_image001%5B6%5D_thumb.png" width="244" height="63" /></a><a href="/assets/archive/clip_image002_6.png"><img title="clip_image002" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image002" src="/assets/archive/clip_image002_thumb_5.png" width="244" height="61" /></a></p>  <p>The last configuration step on the CUP Server is to update the public FQDN using <strong>System</strong>, <strong>Service Parameters</strong>, <strong>Federation Routing Parameters</strong>:</p>  <p><a href="/assets/archive/clip_image001%5B8%5D.png"><img title="clip_image001[8]" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="clip_image001[8]" src="/assets/archive/clip_image001%5B8%5D_thumb.png" width="244" height="29" /></a></p>  <p><strong>Note:</strong> The documentation and help context for this parameter state that it should not be changed, although I found the Federation Routing FQDN will be used in the Record-Route Header (maddr field) and if Lync does not have a Trusted Application Pool for this FQDN, communication will fail.</p>  <p>Lastly we’ll have to restart some services on the CUP Server in order for the configuration changes to become active. To do this, we need to log-in to the “IM and Presence Serviceability” website, which can be found at /ccmservice.</p>  <p>Navigate to <strong>Tools</strong>,<strong> Control Center</strong>, <strong>Feature Services </strong>and restart SIP Proxy Service, then navigate to <strong>Tools</strong>, <strong>Control Center</strong>, <strong>Network Services </strong>and restart the XCP Router Service.</p>  <p>Ok, so that’s it on the Cisco side of things. <a href="/post/Lync-SIP-inter-domain-federation-with-Cisco-Unified-Presence-2.aspx" target="_blank">Click here</a> for the Lync Server Configuration.</p>  <p>Tom</p>
{% include imported_disclaimer.html %}
